# 要件定義書

## はじめに

McCallは、ラベル付きの複数ステップタイムラインを自動進行・反復できるmacOS向けタイマーアプリです。ルーティンで最強の男イコライザーのロバートマッコールから命名されました。

このアプリは、Mac上で仕事をしながら8〜12ステップ程度の細かいルーチンを回したいユーザーを対象としています。各ステップごとに確認（Check-in）を設定でき、サウンドの制御も可能です。メモ機能は含まず、既存のツール（Notion/Obsidian/紙）との連携を前提としています。

## 要件

### 要件1：ルーチン管理

**ユーザーストーリー：** 開発者として、複数のステップからなるルーチンを作成・編集・保存できるようにしたい。そうすることで、自分の作業パターンを体系化できる。

#### 受け入れ基準

1. WHEN ユーザーがルーチンを作成する THEN システムは名前、ステップリスト、リピートモード、自動進行設定、通知設定、サウンド設定を保存できる SHALL
2. WHEN ユーザーがステップを追加する THEN システムは順序、ラベル、時間（秒）、指示文、サウンド設定、集計設定、Check-in設定を保存できる SHALL
3. WHEN ユーザーがルーチンを編集する THEN システムは変更を次回実行時から反映する SHALL
4. WHEN アプリが再起動される THEN システムは保存されたルーチンを復元する SHALL

### 要件2：タイマー実行

**ユーザーストーリー：** 開発者として、作成したルーチンを自動進行で実行できるようにしたい。そうすることで、手動操作なしに集中して作業できる。

#### 受け入れ基準

1. WHEN ユーザーがルーチンを開始する THEN システムは最初のステップから順番にタイマーを実行する SHALL
2. WHEN ステップの時間が終了する THEN システムは自動的に次のステップに遷移する SHALL
3. WHEN ユーザーがPauseを選択する THEN システムはタイマーを一時停止し、Resumeで再開できる SHALL
4. WHEN ユーザーがSkipを選択する THEN システムは現在のステップを終了し次のステップに進む SHALL
5. WHEN ユーザーがStopを選択する THEN システムは確認後にセッションを終了する SHALL
6. WHEN 全ステップが完了する THEN システムはリピート設定に従って繰り返すか終了する SHALL

### 要件3：Check-in機能

**ユーザーストーリー：** 開発者として、特定のステップで確認を求められるようにしたい。そうすることで、無意識に流れることなく意思決定を促される。

#### 受け入れ基準

1. WHEN ステップのCheck-inがoffに設定されている THEN システムは確認を表示しない SHALL
2. WHEN ステップのCheck-inがpromptに設定されている THEN システムは非強制の確認を表示し、タイムアウト後も進行を続ける SHALL
3. WHEN ステップのCheck-inがgateに設定されている THEN システムはDone/Skipが選択されるまで次のステップに進まない SHALL
4. WHEN promptモードでタイムアウトが発生する THEN システムはtimedOut=trueとしてskip扱いで記録する SHALL
5. WHEN ユーザーがDoneまたはSkipを選択する THEN システムは選択結果と反応時間を記録する SHALL

### 要件4：サウンド制御

**ユーザーストーリー：** 開発者として、ステップ切り替え時のサウンドを柔軟に制御したい。そうすることで、会議中や夜間でも適切に使用できる。

#### 受け入れ基準

1. WHEN ルーチンのsoundDefaultがonに設定されている THEN システムはステップ切り替え時にサウンドを再生する SHALL
2. WHEN ステップのsoundOverrideがinherit以外に設定されている THEN システムはステップ個別の設定を優先する SHALL
3. WHEN グローバルミュートが有効になっている THEN システムは全ての設定に関係なくサウンドを再生しない SHALL
4. WHEN ユーザーがメニューバーのサウンドアイコンをクリックする THEN システムはグローバルミュートを即座に切り替える SHALL
5. WHEN サウンドが再生される THEN システムは再生状態をログに記録する SHALL

### 要件5：セッションログと統計

**ユーザーストーリー：** 開発者として、実行履歴と統計を確認できるようにしたい。そうすることで、自分の作業パターンを分析し改善できる。

#### 受け入れ基準

1. WHEN セッションが実行される THEN システムは開始時刻、終了時刻、各ステップの実績、Check-in結果を記録する SHALL
2. WHEN ステップがcountAsBreak=trueに設定されている THEN システムはそのステップを休憩時間として集計する SHALL
3. WHEN ステップがcountAsBreak=falseに設定されている THEN システムはそのステップを作業時間として集計する SHALL
4. WHEN ユーザーが統計を確認する THEN システムは今日/週の回数、総作業時間、休憩時間、Check-inのskip率を表示する SHALL
5. WHEN セッション中にミュートが使用される THEN システムはミュート使用状況を記録する SHALL

### 要件6：メニューバー常駐

**ユーザーストーリー：** 開発者として、他のアプリを使用中でも現在の状態を確認できるようにしたい。そうすることで、作業を中断することなく進行状況を把握できる。

#### 受け入れ基準

1. WHEN タイマーが実行中である THEN システムはメニューバーに残り時間とステップ名を表示する SHALL
2. WHEN サウンドの状態が変更される THEN システムはメニューバーのアイコンを更新する SHALL
3. WHEN ユーザーがメニューバーアイテムをクリックする THEN システムは基本操作（Start/Pause/Skip/Stop/Mute切替）を提供する SHALL
4. WHEN gateモードのCheck-inが表示される THEN システムはメニューバーで待機状態を示す SHALL

### 要件7：キーボードショートカット

**ユーザーストーリー：** 開発者として、マウスを使わずにキーボードだけで操作できるようにしたい。そうすることで、作業の流れを中断せずに制御できる。

#### 受け入れ基準

1. WHEN ユーザーがSpaceキーを押す THEN システムはPause/Resumeを実行する SHALL
2. WHEN ユーザーが⌘⏎を押す THEN システムはStartを実行する SHALL
3. WHEN ユーザーが⌘→を押す THEN システムはSkipを実行する SHALL
4. WHEN Check-inダイアログが表示されている THEN システムはEnterでDone、SでSkipを実行する SHALL
5. WHEN グローバルショートカットが設定されている THEN システムは他のアプリからでも操作を受け付ける SHALL

### 要件8：システム安定性

**ユーザーストーリー：** 開発者として、システムのスリープや復帰でタイマーが壊れないようにしたい。そうすることで、信頼性の高いツールとして使用できる。

#### 受け入れ基準

1. WHEN システムがスリープから復帰する THEN システムはmonotonic clockに基づいて正確な残り時間を表示する SHALL
2. WHEN アプリが予期せず終了する THEN システムは次回起動時に実行中だったセッションをaborted状態で記録する SHALL
3. WHEN 通知権限がない場合でも THEN システムはUI上でステップ遷移を明確に示す SHALL
4. WHEN Bluetoothが切断されるなどサウンドが鳴らない環境でも THEN システムは視覚的な通知で運用を継続できる SHALL

### 要件9：初期テンプレート

**ユーザーストーリー：** 開発者として、すぐに使える10分スプリントテンプレートが欲しい。そうすることで、設定に時間をかけずに使い始められる。

#### 受け入れ基準

1. WHEN アプリが初回起動される THEN システムは「10分ミニ・スプリント」テンプレートを提供する SHALL
2. WHEN テンプレートが作成される THEN システムは8ステップ（タスク1行/完了条件/環境整備/集中/停止/メモ/回復/次の着火準備）を含む SHALL
3. WHEN テンプレートが作成される THEN システムはメモステップにgate mode Check-inを設定する SHALL
4. WHEN テンプレートが作成される THEN システムは回復ステップをcountAsBreak=trueに設定する SHALL
5. WHEN ユーザーがテンプレートを複製する THEN システムは新しいルーチンとして保存する SHALL