# 実装計画

- [x] 1. プロジェクト構造とコア型定義の設定（Done）
  - Rustでのデータモデル（Routine, Step, Session等）の型定義を作成
  - TypeScriptでのフロントエンド型定義を作成
  - Tauri commandsの基本構造を定義
  - _要件: 1.1, 1.2, 1.3_

- [x] 2. データ永続化レイヤーの実装
  - [x] 2.1 Rustでのファイルベースデータストレージを実装（Done）
    - DataManagerモジュールを作成してJSON形式でのルーチン保存・読み込み機能を実装
    - エラーハンドリングとファイルI/O処理を含む
    - _要件: 1.4, 8.2_

  - [x] 2.2 セッションデータの永続化機能を実装（Done）
    - セッション実行履歴の保存・読み込み機能を実装
    - 統計計算のためのデータクエリ機能を実装
    - 不足: 通常フローでのSession/StepRun/SessionTotals生成・保存が未実装（異常終了復旧のみ保存）
    - 不足: Check-in結果/サウンド再生/ミュート使用の保存が通常フローで未実装
    - _要件: 5.1, 5.4_

  - [x] 2.3 設定データの永続化機能を実装（Done）
    - settings.json の読み書き（notificationsEnabled, soundDefault など）
    - フロントのAppSettingsと同期
    - _要件: 追加（設定永続化）_

- [x] 3. タイマーエンジンのコア実装
  - [x] 3.1 基本的なタイマー機能を実装（Done）
    - TimerEngineモジュールでstart/pause/resume/stop機能を実装
    - monotonic clockを使用した正確な時間管理を実装
    - _要件: 2.1, 2.2, 2.3, 2.5, 8.1_

  - [x] 3.2 ステップ自動遷移機能を実装（Done）
    - ステップ終了時の自動進行ロジックを実装
    - リピートモード（infinite/count/duration）の処理を実装
    - _要件: 2.2, 2.6_

- [x] 3.3 Check-in機能の実装（Done）
    - off/prompt/gateの3モードでのCheck-in処理を実装
    - タイムアウト処理とレスポンス記録機能を実装
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 3.4 autoAdvance=false の挙動実装（Done）
    - 自動遷移しない場合の停止/待機UI挙動を定義し実装
    - _要件: 2.2_

- [x] 4. サウンド管理システムの実装（Done）
  - AudioManagerモジュールでサウンド再生機能を実装
  - グローバルミュート、ルーチンデフォルト、ステップ個別設定の優先順位処理を実装
  - サウンド再生状況のログ記録機能を実装
  - 不足: サウンド再生ログがSession/StepRunに永続化されない
  - _要件: 4.1, 4.2, 4.3, 4.5_

- [x] 5. Tauri commandsとイベントシステムの実装
  - [x] 5.1 基本的なTauri commandsを実装（Done）
    - start_routine, pause_timer, resume_timer, skip_step, stop_timerコマンドを実装
    - フロントエンドからバックエンドへの操作インターフェースを確立
    - _要件: 2.1, 2.3, 2.4, 2.5_

  - [x] 5.2 リアルタイム更新のためのイベントシステムを実装（Done）
    - timer-tick, step-changed, check-in-requiredなどのイベント送信機能を実装
    - フロントエンドでのリアルタイム状態更新を可能にする
    - _要件: 2.1, 2.2, 3.2, 3.3_

  - [x] 5.3 現在状態取得コマンドの実装（Done）
    - get_timer_state で実行中状態/残り時間/チェックイン待ち/セッション情報を返す
    - アプリ再起動時のUI復元に使用
    - _要件: 8.1, 8.2_

- [x] 6. React フロントエンドの基本構造実装（未完了）
  - [x] 6.1 アプリケーション状態管理を実装（Done）
      - AppStateとTimerStateの状態管理ロジックを実装
      - Tauri eventsを受信して状態を更新する仕組みを実装
      - _要件: 2.1, 2.2, 2.3_

  - [x] 6.2 基本的なUIコンポーネントを実装（Done）
    - App, TimerView, RoutineEditorの基本構造を実装
    - UIスタイルガイドに従ったデザインシステムを適用
    - _要件: 1.1, 2.1_

  - [x] 6.3 画面遷移/導線（Timer/Editor/Stats）を実装（Done）
      - ルートからルーチン編集・統計画面へ遷移できるUIを追加
      - キーボードファーストの操作導線を設計
      - _要件: 1.1, 5.4, 6.1_

- [x] 7. タイマー実行画面の実装
  - [x] 7.1 タイマー表示コンポーネントを実装（Done）
      - StepBadge, TimerDisplay, InstructionTextコンポーネントを実装
      - monospaced digitsでの時間表示とリアルタイム更新を実装
      - _要件: 2.1, 2.2_

    - [x] 7.2 タイマー制御ボタンを実装（Done）
      - Pause/Resume/Skip/Stopボタンの機能を実装
      - キーボードショートカット（Space, ⌘⏎, ⌘→）を実装
      - _要件: 2.3, 2.4, 2.5, 7.1, 7.2, 7.3_

    - [x] 7.3 Stop確認ダイアログの実装（Done）
      - Stop時に確認を挟む
      - _要件: 2.5_

- [x] 8. Check-inダイアログシステムの実装（Done）
  - [x] 8.1 Gateモードのモーダルダイアログを実装（Done）
    - Done/Skipボタンを持つモーダルダイアログを実装
    - Enter（Done）、S（Skip）のキーボード操作を実装
    - _要件: 3.2, 3.3, 7.4_

  - [x] 8.2 Promptモードの非モーダル通知を実装（Done）
    - タイムアウト付きの非モーダル確認UIを実装
    - 自動進行しながらの確認機能を実装
    - _要件: 3.2, 3.4_

- [x] 9. ルーチン編集機能の実装
  - [x] 9.1 ルーチン作成・編集UIを実装（Done）
    - ステップの追加・削除・並び替え機能を実装
    - ルーチン全体設定（名前、リピートモード、サウンドデフォルト）の編集を実装
    - _要件: 1.1, 1.2_

  - [x] 9.2 ステップ詳細設定UIを実装（Done）
    - 時間、ラベル、指示文の編集機能を実装
    - サウンド設定（inherit/on/off）、集計設定（countAsBreak）、Check-in設定の編集を実装
    - _要件: 1.2, 4.2, 5.2, 5.3, 3.1, 3.2, 3.3_

  - [x] 9.3 ルーチン全体設定の不足UIを追加（Done）
    - autoAdvance / notifications / soundScheme の編集UI
    - _要件: 1.1, 2.2, 4.1_

- [x] 10. システム統合機能の実装（Done）
  - [x] 10.1 macOSメニューバー統合を実装（Done）
      - メニューバーでの現在状態表示（残り時間、ステップ名、サウンド状態）を実装
      - メニューバーからの基本操作（Start/Pause/Skip/Stop/Mute切替）を実装
      - _要件: 6.1, 6.2, 6.3, 4.4_

  - [x] 10.2 通知システムを実装（Done）
      - ステップ切り替え時の通知表示を実装
      - 通知権限がない場合の代替UI表示を実装
      - _要件: 2.2, 8.3_

    - [x] 10.3 グローバルショートカットを実装（Done）
      - 他のアプリからでも操作可能なグローバルショートカットを実装
      - ショートカットの登録と処理を実装
      - _要件: 7.5_

- [x] 11. 統計・ログ機能の実装（Done）
  - [x] 11.1 セッション統計の計算を実装（Done）
    - 作業時間・休憩時間の集計機能を実装
    - Check-in skip率の計算機能を実装
    - _要件: 5.2, 5.3, 5.4_

  - [x] 11.2 統計表示UIを実装（Done）
    - 今日/週の実行回数、時間統計、skip率の表示を実装
    - ミュート使用率の表示を実装
    - _要件: 5.4, 5.5_

- [x] 12. 初期テンプレートとデフォルト設定の実装（Done）
  - 10分ミニ・スプリントテンプレートの作成機能を実装
  - 8ステップ構成とデフォルト設定（メモステップのgate mode、回復ステップのcountAsBreak=true）を実装
  - テンプレート複製機能を実装
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 13. エラーハンドリングと安定性の実装（Done）
  - [x] 13.1 包括的なエラーハンドリングを実装（Done）
      - システムエラー、データエラー、タイマーエラーの適切な処理を実装
      - エラー状態からの復旧機能を実装
      - _要件: 8.2, 8.4_

    - [x] 13.2 システム復旧機能を実装（Done）
      - スリープ/復帰時の状態復元機能を実装
      - アプリ再起動時の実行中セッション処理を実装
      - _要件: 8.1, 8.2_

- [x] 14. テストの実装
  - [x] 14.1 Rustバックエンドのユニットテストを実装（Done）
      - TimerEngine, AudioManager, DataManagerのテストを実装
      - エラーケースと境界値のテストを実装
      - _要件: 全要件の検証_

  - [x] 14.2 Reactコンポーネントのテストを実装（Done）
      - 主要コンポーネントのレンダリングとイベントハンドリングテストを実装
      - Check-inダイアログの動作テストを実装
      - _要件: 全要件の検証_

- [x] 15. 最終統合とポリッシュ
  - [x] 15.1 E2Eテストシナリオの実行（Done）
        - 基本ワークフロー（ルーチン作成→実行→統計確認）のテストを実行
        - Check-in機能とサウンド制御の統合テストを実行
        - 不足: ルーチン作成/統計確認のE2Eが未実装
        - _要件: 全要件の統合検証_

    - [x] 15.2 パフォーマンス最適化とUIポリッシュ（Done）
      - メモリ使用量とCPU使用率の最適化を実施
      - UIスタイルガイドに従った最終的な見た目の調整を実施
      - _要件: 非機能要件の最適化_

- [x] 16. GitHub ActionsのCIを追加（Done）
  - bun/rustのチェックを自動実行するワークフローを追加

- [x] 17. UIレイアウト崩れの修正（Done）
  - 画面レイアウトの崩れを修正し、Timer/Editor/Statsの配置を安定させる

- [x] 18. Playwright UIスナップショットスクリプト追加（Done）

- [x] 19. 固定ウィンドウサイズ(600x700)とレイアウト最適化、Tauriの<select>視認性改善（Done）
- [x] 20. select UIスタイルの統一（Done）
- [x] 21. selectの立体感を排除しフィールドと統一（Done）
  - Timer/Edit/Statsのスクリーンショットを取得するスクリプトを追加

- [x] 18.1 TauriベースのUIスナップショットへ移行（Done）
  - tauri-driver経由で実アプリUIのスナップショットを取得
  - テスト用データ投入と実行手順を整備

- [x] 18.2 macOS向けローカルスナップショット実行の補強（Done）
  - AppleScript + screencapture で外部APIなしの実行フローを追加

- [x] 18.3 スナップショットスクリプトのBun移行（Done）
  - Bun APIを使った実行フローに整理
